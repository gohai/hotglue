$.glue.image=function(){var a=false;var b=false;return{autoresize:function(i,k){if(k===undefined){k="center"}var e=$.glue.conf.image.upload_resize_larger;var m=$.glue.conf.image.upload_resize_to;if(e=="0%"&&m=="0%"){return}var n=$(i).width();var j=$(i).height();var o=$(window).width();var l=$(window).height();var d=parseFloat(e);var g=parseFloat(m);if(isNaN(d)||isNaN(g)){return}var p=false;var f=n;var c=j;if(o*d/100<n){f=o*g/100;c=f*j/n;p=true}if(l*d/100<j){if(l*g/100<c){c=l*g/100;f=c*n/j;p=true}}if(p){$(i).css("width",f+"px");$(i).css("height",c+"px");if(k=="center"){$(i).css("left",($(i).position().left+(n-f)/2)+"px");$(i).css("top",($(i).position().top+(j-c)/2)+"px")}$.glue.object.resizable_update_tooltip(i);$.glue.image.resize(i,k)}},resize:function(e,f){if(!$.glue.conf.image.resizing||$(e).css("background-repeat")!="no-repeat"){return}if(f===undefined){f="center"}var d=$(e).width();var c=$(e).height();$.glue.backend({method:"image.resize",name:$(e).attr("id"),width:d,height:c},function(h){if(!h){console.error("image.resize returned null")}else{if(h["#error"]){console.error(h["#data"])}else{if(!h["#data"]){}else{clearTimeout(b);var g=$(e).clone();$(g).attr("id","");$(g).attr("class","glue-object-copy");if(f=="center"){$(g).css("left",($(e).position().left+($(e).outerWidth()-d)/2)+"px");$(g).css("top",($(e).position().top+($(e).outerHeight()-c)/2)+"px")}$(g).css("background-image","url("+$.glue.base_url+"?"+$(e).attr("id")+"&w="+d+"&h="+c+")");$(e).before(g);$(e).one("glue-movestart",function(){$(".glue-object-copy").remove()});$(e).one("glue-resizestart",function(){$(".glue-object-copy").remove()});$(e).one("glue-unregister",function(){$(".glue-object-copy").remove()});a=g;b=setTimeout(function(){$(e).css("background-image","url("+$.glue.base_url+"?"+$(e).attr("id")+"&w="+d+"&h="+c+")");var i=a;setTimeout(function(){$(i).remove()},500);a=false},500)}}}},false)}}}();$(".image").live("glue-resizestop",function(a){$.glue.image.resize($(this))});$(".image").live("glue-upload-dynamic-late",function(c,b){var a=b;if($(a).is("img")){if($(a).width()==0){$(this).css("width","100px");$(this).css("height","100px");$(a).css("width","100%");$(a).css("height","100%")}else{$(this).css("width",$(a).width()+"px");$(this).css("height",$(a).height()+"px");$.glue.backend({method:"glue.update_object",name:$(this).attr("id"),"image-file-width":$(a).width(),"image-file-height":$(a).height()});$(this).css("background-image","url("+$(a).attr("src")+")");$(this).css("background-repeat","no-repeat");$(this).css("background-size","100% 100%");$(this).css("-moz-background-size","100% 100%");$(a).remove();$.glue.image.autoresize(this)}}});$(".image").live("glue-upload-static",function(a,b){$.glue.image.autoresize(this,b)});$(document).ready(function(){$.glue.contextmenu.veto("iframe","object-link");var a=$('<img src="'+$.glue.base_url+'modules/image/image-tile.png" alt="btn" title="toggle image tiling" width="32" height="32">');$(a).bind("click",function(c){var b=$(this).data("owner");if($(b).css("background-repeat")!="no-repeat"){$(b).css("background-repeat","no-repeat");$(b).css("background-size","100% 100%");$(b).css("-moz-background-size","100% 100%")}else{$(b).css("background-repeat","repeat");$(b).css("background-size","");$(b).css("-moz-background-size","")}$.glue.object.save(b)});$.glue.contextmenu.register("image","image-tile",a);a=$('<img src="'+$.glue.base_url+'modules/image/image-ratio.png" alt="btn" title="reset image size" width="32" height="32">');$(a).bind("click",function(c){var b=$(this).data("owner");$.glue.backend({method:"glue.load_object",name:$(b).attr("id")},function(e){if(e["image-file-width"]&&e["image-file-height"]){var d=e["image-file-width"]/e["image-file-height"];$(b).trigger("glue-resizestart");if(c.shiftKey){$(b).css("height",($(b).width()/d)+"px")}else{if(c.ctrlKey){$(b).css("width",($(b).height()*d)+"px")}else{$(b).css("width",e["image-file-width"]+"px");$(b).css("height",e["image-file-height"]+"px")}}$(b).trigger("glue-resize");$.glue.object.resizable_update_tooltip(b);$.glue.object.save(b);$(b).trigger("glue-resizestop");$.glue.canvas.update(b)}})});$.glue.contextmenu.register("image","image-ratio",a);a=$('<img src="'+$.glue.base_url+'modules/image/image-pos.png" alt="btn" title="adjust image selection" width="32" height="32">');$(a).bind("mousedown",function(h){var g=$(this).data("owner");var c=$(g).css("background-position").split(" ");if(c.length!=2){var b=0;var d=0}else{var b=parseInt(c[0]);if(isNaN(b)){b=0}var d=parseInt(c[1]);if(isNaN(d)){d=0}}var f=true;$.glue.slider(h,function(e,i){$(g).css("background-position",(b+e)+"px "+(d+i)+"px");if(e!=0||i!=0){f=false}},function(e,i){if(f){$(g).css("background-position","");$.glue.backend({method:"glue.object_remove_attr",name:$(g).attr("id"),attr:"image-background-position"})}else{$.glue.object.save(g)}});return false});$.glue.contextmenu.register("image","image-pos",a);a=$('<img src="'+$.glue.base_url+'img/download.png" alt="btn" title="download original file" width="32" height="32">');$(a).bind("click",function(c){var b=$(this).data("owner");window.location=$.glue.base_url+"?"+$(b).attr("id")+"&download=1"});$.glue.contextmenu.register("image","image-download",a)});
